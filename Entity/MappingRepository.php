<?php

namespace Unifik\SystemBundle\Entity;

use Unifik\SystemBundle\Lib\BaseEntityRepository;

/**
 * MappingRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class MappingRepository extends BaseEntityRepository
{
    public function findRoute($route, $locale, $app_id = null) {
        $queryBuilder = $this->createQueryBuilder('m')
            ->select('m', 's', 'st', 'a')
            ->innerJoin('m.app', 'a')
            ->innerJoin('m.section', 's')
            ->innerJoin('s.translations', 'st')
            ->andWhere('m.type = :type_route')
            ->andWhere('m.target = :route')
            ->andWhere('st.locale = :locale')
            ->andWhere('st.active = true')
            ->setParameter('type_route', 'route')
            ->setParameter('route', $route)
            ->setParameter('locale', $locale)
            ->addOrderBy('m.ordering', 'ASC')
            ;
        if ($app_id) {
            $queryBuilder->andWhere('a.id = :app_id')
                ->setParameter('app_id', $app_id)
                ;
        }

        return $this->processQuery($queryBuilder);
    }
}
